<!DOCTYPE>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Lepton Web UI</title>
		<script type="text/javascript">

			var imageData = [[]];
			var loading = false;
		
			function drawImage() {
				var min = 0, max = 0;

				for(var row = 0; row < imageData.length; row++) {
					for(var col = 0; col < imageData[row].length; col++) {
						min = Math.min(min, imageData[row][col]);
						max = Math.max(max, imageData[row][col]);
					}
				}

				var range = max - min;
				var div = Math.round(16383 / range);
				//var range = Math.round((max - min) / 3);
				//var div = Math.round(range / 256);
				
				var canvas = document.getElementById("leptonCanvas");
				var ctx = canvas.getContext("2d");
				ctx.clearRect(0, 0, canvas.width, canvas.height);

				var canvas2 = document.getElementById("leptonCanvas2");
				var ctx2 = canvas2.getContext("2d");
				ctx2.clearRect(0, 0, canvas2.width, canvas2.height);
							
				window.imageData.forEach(function(rowData, row) {
					rowData.forEach(function(value, col) {
						value = Math.min(value, 16383);						
						value -= min;
						var rgb = (Math.floor((value * div) / 64)).toString(16);
						ctx.fillStyle = '#' + ('00'.substr(rgb.length) + rgb) + ('00'.substr(rgb.length) + rgb) + ('00'.substr(rgb.length) + rgb);
						ctx.fillRect(col * 4,row * 4, 4, 4);      


						var r,g,b;
						b = (Math.floor((value * div) / 64)).toString(16);
						value = Math.max(value - (range/3), 0);
						g = (Math.floor((value * div) / 64)).toString(16);
						value = Math.max(value - (range/3), 0);
						r = (Math.floor((value * div) / 64)).toString(16);
						ctx2.fillStyle = '#' + ('00'.substr(r.length) + r) + ('00'.substr(g.length) + g) + ('00'.substr(b.length) + b);
						ctx2.fillRect(col * 4,row * 4, 4, 4);      
					});
				});
				
			}

			function loadImage() {

				if(loading) {
					return;
				}

				loading = true;

				var xhttp = new XMLHttpRequest();

				xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						loading = false;

						var result = JSON.parse(this.responseText);
						if(!result.data) {
							return;
						}
						window.imageData = result.data;	

						drawImage();					
					}
				};				
				xhttp.open("GET", "lepton.json", true);
				xhttp.send();
			}

			function init() {
				setInterval(loadImage, 5000);
				loadImage();
			}
		</script>
	</head>

	<body onload="init();">
	<canvas id="leptonCanvas" width="640" height="480" style="border:1px solid #999;">
	</canvas>
	<canvas id="leptonCanvas2" width="640" height="480" style="border:1px solid #999;">
    </canvas>	
	</body>
</html>
